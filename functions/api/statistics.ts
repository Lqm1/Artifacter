import { dbkvGet, dbkvSet, resStatus } from '../utils'

// Cloudflare Cache Rule を利用

type Env = {
  statistics: D1Database
}

const KEY = 'statistics'

export const onRequestGet: PagesFunction<Env> = async ctx => {
  if (ctx.request.headers.get('sec-fetch-site') !== 'same-origin') return resStatus(403)

  //********** set test data **********
  //await setTestData(ctx.env.statistics)

  //********** get data **********
  const statData = (await dbkvGet(ctx.env.statistics, KEY))?.value
  return new Response(statData, {
    headers: { 'Content-Type': 'application/json' },
  })
}

//********** set test data **********
const setTestData = (db: D1Database) =>
  dbkvSet(
    db,
    KEY,
    Date.now(),
    '{"playerInfo":{"count":4,"level":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],"finishAchievementNum":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],"finishAchievementNum100":[0,0,0,0,0,0,0,1,0,2,0,1],"finishAchievementNumTop":1163,"towerFloorIndex":[0,0,0,0,0,0,0,0,0,0,0,0,4],"theaterActIndex":[1,0,0,0,0,0,0,0,0,0,3]},"avatarInfoList":[{"avatarId":10000099,"count":3,"consts":[0,0,2,0,0,0,1],"stats":[{"fightProp":2000,"value":{"mean":19862.315755208332,"median":19707.140625}},{"fightProp":2001,"value":{"mean":2096.7957356770835,"median":2105.99267578125}},{"fightProp":2002,"value":{"mean":964.5991821289062,"median":1011.4921264648438}},{"fightProp":28,"value":{"mean":39.62999979654948,"median":58.279998779296875}},{"fightProp":20,"value":{"mean":0.8080160021781921,"median":0.7735679745674133}},{"fightProp":22,"value":{"mean":2.0212000211079917,"median":1.8863999843597412}},{"fightProp":23,"value":{"mean":1.1446333328882854,"median":1.103600025177002}},{"value":{"mean":0.4659999907016754,"median":0.4659999907016754}}],"weapon":[{"id":13513,"count":2},{"id":13505,"count":1}],"reliquarySet":[{"set":[{"id":15036,"piece":4}],"count":3}],"skills":[{"id":10991,"mean":5.666666666666667,"median":6,"mode":1},{"id":10992,"mean":9.333333333333334,"median":10,"mode":10},{"id":10995,"mean":9,"median":9,"mode":8}]},{"avatarId":10000098,"count":3,"consts":[0,1,1,0,0,0,1],"stats":[{"fightProp":2000,"value":{"mean":20161.079427083332,"median":19652.37109375}},{"fightProp":2001,"value":{"mean":2403.817138671875,"median":2289.865234375}},{"fightProp":2002,"value":{"mean":903.0466512044271,"median":913.5885009765625}},{"fightProp":28,"value":{"mean":22.53333282470703,"median":0}},{"fightProp":20,"value":{"mean":0.6256666580835978,"median":0.6152999997138977}},{"fightProp":22,"value":{"mean":2.2942240238189697,"median":2.328824043273926}},{"fightProp":23,"value":{"mean":1.097100019454956,"median":1.0906000137329102}},{"value":{"mean":0.5059999907016755,"median":0.4659999907016754}}],"weapon":[{"id":11515,"count":2},{"id":11509,"count":1}],"reliquarySet":[{"set":[{"id":15035,"piece":4}],"count":3}],"skills":[{"id":10981,"mean":7,"median":10,"mode":10},{"id":10982,"mean":9.666666666666666,"median":10,"mode":10},{"id":10985,"mean":9.333333333333334,"median":10,"mode":10}]},{"avatarId":10000089,"count":4,"consts":[0,0,2,0,0,0,2],"stats":[{"fightProp":2000,"value":{"mean":33339.7373046875,"median":33748.0380859375}},{"fightProp":2001,"value":{"mean":1313.7753078613282,"median":1253.637451171875}},{"fightProp":2002,"value":{"mean":828.4848022460938,"median":811.4329833984375}},{"fightProp":28,"value":{"mean":32.052499294281006,"median":31.469998359680176}},{"fightProp":20,"value":{"mean":0.8071559816598892,"median":0.815449982881546}},{"fightProp":22,"value":{"mean":2.3758859038352966,"median":2.213547945022583}},{"fightProp":23,"value":{"mean":1.569900006055832,"median":1.650849997997284}},{"value":{"mean":0.11649999767541885,"median":0}}],"weapon":[{"id":11513,"count":3},{"id":11505,"count":1}],"reliquarySet":[{"set":[{"id":15032,"piece":4}],"count":3},{"set":[{"id":15031,"piece":4}],"count":1}],"skills":[{"id":10891,"mean":6.25,"median":7.5,"mode":9},{"id":10892,"mean":10,"median":10,"mode":10},{"id":10895,"mean":10,"median":10,"mode":10}]}],"timestamp":1731999694684}',
  )
