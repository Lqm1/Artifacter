import { dbkvGet, dbkvSet, resStatus } from '../utils'

type Env = {
  statistics: D1Database
}

const KEY = 'statistics'

export const onRequestGet: PagesFunction<Env> = async ctx => {
  if (ctx.request.headers.get('sec-fetch-site') !== 'same-origin') return resStatus(403)

  //********** set test data **********
  await setTestData(ctx.env.statistics)

  //********** get data **********
  const statData = (await dbkvGet(ctx.env.statistics, KEY))?.value
  return new Response(statData, {
    headers: { 'Content-Type': 'application/json', 'Cache-Control': `max-age=${60 * 60}` },
  })
}

//********** set test data **********
const setTestData = (db: D1Database) =>
  dbkvSet(
    db,
    KEY,
    Date.now(),
    '{"playerInfo":{"count":3,"level":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],"finishAchievementNum":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],"finishAchievementNum100":[0,0,0,0,0,0,0,1,0,2],"finishAchievementNumTop":954,"towerFloorIndex":[0,0,0,0,0,0,0,0,0,0,0,0,3],"theaterActIndex":[0,0,0,0,0,0,0,0,0,0,3]},"avatarInfoList":[{"avatarId":10000089,"count":3,"consts":[{"count":0},{"count":0},{"count":2},{"count":0},{"count":0},{"count":0},{"count":1}],"stats":[{"type":"HP","fightProp":2000,"icon":"FIGHT_PROP_HP","value":{"mean":34217.862630208336,"median":34741.82421875}},{"type":"ATK","fightProp":2001,"icon":"FIGHT_PROP_ATTACK","value":{"mean":1357.2597366536459,"median":1317.79736328125}},{"type":"DEF","fightProp":2002,"icon":"FIGHT_PROP_DEFENSE","value":{"mean":835.0641682942709,"median":814.1192626953125}},{"type":"Elemental Mastery","fightProp":28,"icon":"FIGHT_PROP_ELEMENT_MASTERY","value":{"mean":35.74333254496256,"median":39.62999725341797}},{"type":"CRIT Rate","fightProp":20,"icon":"FIGHT_PROP_CRITICAL","value":{"mean":0.8827746510505676,"median":0.9106999635696411}},{"type":"CRIT DMG","fightProp":22,"icon":"FIGHT_PROP_CRITICAL_HURT","value":{"mean":2.1423985958099365,"median":2.182447910308838}},{"type":"Energy Recharge","fightProp":23,"icon":"FIGHT_PROP_CHARGE_EFFICIENCY","value":{"mean":1.7231666644414265,"median":1.679900050163269}},{"type":"Elemental DMG Bonus","icon":"None","value":{"mean":0,"median":0}}],"weapon":[{"id":11513,"icon":"UI_EquipIcon_Sword_Regalis","nameTextMapHash":"1473399443","rankLevel":5,"count":2},{"id":11505,"icon":"UI_EquipIcon_Sword_Morax","nameTextMapHash":"1345343763","rankLevel":5,"count":1}],"reliquarySet":[{"set":[{"id":15032,"icon":"UI_RelicIcon_15032_4","piece":4,"nameTextMapHash":"3410220315"}],"count":3}],"skills":[{"id":10891,"mean":5.333333333333333,"median":6,"mode":1},{"id":10892,"mean":10,"median":10,"mode":10},{"id":10895,"mean":10,"median":10,"mode":10}]}],"timestamp":1731916482597}',
  )
