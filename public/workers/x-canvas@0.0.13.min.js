const S="Helvetica Neue, Arial, Hiragino Kaku Gothic ProN, Hiragino Sans, Meiryo, sans-serif",P=m=>typeof m!="object"||m instanceof ImageBitmap,v=m=>fetch(self.location.origin+m).then(t=>t.blob()).then(t=>createImageBitmap(t)),k=m=>{let[t,e,i]=m;return typeof e=="string"&&!e.startsWith("url(")&&(e=`url(${self.location.origin+e})`),i||(i={display:"swap"}),[t,e,i]},p=(m,t,e)=>{const i=m.width,n=m.height,o=t.w/t.h,a=i/n;let c;if("objectFit"in e&&e.objectFit==="cover"?(o<a&&(c="y"),a<o&&(c="x")):(o<a&&(c="x"),a<o&&(c="y")),c==="x"){const s={w:t.w,h:n*t.w/i},r=t.y+t.h/2-s.h/2;return[0,0,i,n,t.x,r,s.w,s.h]}const l={w:i*t.h/n,h:t.h},f=t.x+t.w/2-l.w/2;return[0,0,i,n,f,t.y,l.w,l.h]},z=m=>typeof m=="string"&&m.at(-1)==="%"?Number(m.slice(0,-1))/100:void 0,F=(m,t,e,i)=>{const n=m.getContext("2d");if(!n)return;const o=m.width,a=m.height,c=n.getImageData(0,0,o,a),l=new ImageData(new Uint8ClampedArray(c.data),o,a),f=new ImageData(new Uint8ClampedArray(c.data),o,a);M(f,e);const s=l.data,r=f.data;for(let h=0;h<s.length;h+=4)for(let u=0;u<3;u++){const d=s[h+u]-r[h+u];Math.abs(d)>i&&(s[h+u]=Math.min(Math.max(s[h+u]+d*t,0),255))}n.putImageData(l,0,0)},M=(m,t)=>{const e=m.width,i=m.height,n=m.data,o=new Uint8ClampedArray(n),a=t/3,c=2*a*a,l=Math.PI*c,f=[];let s=0;for(let r=-t;r<=t;r++){const h=Math.exp(-(r*r)/c)/l;f.push(h),s+=h}for(let r=0;r<f.length;r++)f[r]/=s;for(let r=0;r<i;r++)for(let h=0;h<e;h++){let u=0,d=0,x=0;for(let b=-t;b<=t;b++){const I=Math.min(Math.max(h+b,0),e-1),y=(r*e+I)*4,w=f[b+t];u+=o[y]*w,d+=o[y+1]*w,x+=o[y+2]*w}const g=(r*e+h)*4;n[g]=u,n[g+1]=d,n[g+2]=x}o.set(n);for(let r=0;r<e;r++)for(let h=0;h<i;h++){let u=0,d=0,x=0;for(let b=-t;b<=t;b++){const y=(Math.min(Math.max(h+b,0),i-1)*e+r)*4,w=f[b+t];u+=o[y]*w,d+=o[y+1]*w,x+=o[y+2]*w}const g=(h*e+r)*4;n[g]=u,n[g+1]=d,n[g+2]=x}};class B{#s;#t;#c;#l=S;#i=16;#d="#000";#g;#n=void 0;#r=new Map;#f=[];#a=!1;constructor(t,e){this.#s=t,this.#t=e}options=t=>{t?.canvasWidth&&(this.#s.width=t.canvasWidth),t?.canvasHeight&&(this.#s.height=t.canvasHeight),t?.fontFace&&(this.#c=new FontFace(...k(t.fontFace)),this.#l=`${t.fontFace[0]}, ${S}`,this.#a=!1,self.fonts.add(this.#c)),t?.fontSize&&(this.#i=t.fontSize),t?.fontColor&&(this.#d=t.fontColor),t?.debugMode&&(this.#g=t.debugMode)};render(t){const e={x:0,y:0,z:0,w:this.#s.width,h:this.#s.height};this.#n={pos:e,elem:t,inner:this.#m(e,t)},this.#a?this.#h():this.#c?.load().then(()=>{self.fonts.check(`${this.#i}px ${this.#l}`)&&(this.#a=!0,this.#n={pos:e,elem:t,inner:this.#m(e,t)},this.#h())}),this.#y()}#m(t,e){if(P(e))return;const i=this.#p(t,e),n=e.children?.map((o,a)=>({pos:i[a],elem:o,inner:void 0}));for(const o of n)o.inner=this.#m(o.pos,o.elem);return n}#p(t,e){const i=this.#e(e.props.p,t.w,0),n=this.#e(e.props.p,t.h,0),o=this.#e(e.props.pt,t.h,n),a=this.#e(e.props.pr,t.w,i),c=this.#e(e.props.pb,t.h,n),l=this.#e(e.props.pl,t.w,i),f=e.children.map(s=>{if(P(s))return{z:0,w:"auto",h:"auto",mt:"auto",mr:"auto",mb:"auto",ml:"auto",position:void 0};const r=this.#e(s.props?.m,this.#i);return{z:s.props?.z??0,w:s.props?.w??(s.type!=="img"?this.#M(s.children[0],s.props.fontSize)??"auto":"auto"),h:s.props?.h??(s.type!=="img"&&(typeof s.children[0]=="string"||typeof s.children[0]=="number")?this.#e(s.props.fontSize,this.#i,this.#i)*1.5:"auto"),mt:s.props?.mt??r,mr:s.props?.mr??r,mb:s.props?.mb??r,ml:s.props?.ml??r,position:s.props?.position}});return e.props?.display==="flex"?this.#x({...t,pt:o,pr:a,pb:c,pl:l},f,"row"):this.#x({...t,pt:o,pr:a,pb:c,pl:l},f)}#x(t,e,i){const n=i==="row",o=t.x+t.pl,a=t.y+t.pt,c=t.w-t.pl-t.pr,l=t.h-t.pt-t.pb,f=this.#b(o,c,e.map(r=>({len:r.w,ms:r.ml,me:r.mr,pos:n?r.position:"absolute"}))),s=this.#b(a,l,e.map(r=>({len:r.h,ms:r.mt,me:r.mb,pos:n?"absolute":r.position})));return e.map((r,h)=>({x:f[h].start,y:s[h].start,z:r.z,w:f[h].len,h:s[h].len}))}#b(t,e,i){let n=0,o=0;for(const s of i)if(s.pos!=="absolute")for(const r of[s.len,s.ms,s.me])n+=this.#e(r,void 0,0),o+=z(r)||0;let a=t;if(e<n||e===n&&0<o)return i.map(s=>{if(s.pos==="absolute")return this.#u(t,e,s);const{start:r,len:h,next:u}=this.#o(a,e,s);return a=u,{start:r,len:h}});const c=(e-n)/e;if(c<o)return i.map(s=>{if(s.pos==="absolute")return this.#u(t,e,s);const{start:r,len:h,next:u}=this.#o(a,e*c/o,s);return a=u,{start:r,len:h}});let l=0,f=0;for(const s of i)s.pos!=="absolute"&&(s.len==="auto"&&l++,s.ms==="auto"&&f++,s.me==="auto"&&f++);return i.map(s=>{if(s.pos==="absolute")return this.#u(t,e,s);if(l>0){const{start:d,len:x,next:g}=this.#o(a,e,s,(e-n-o*e)/l);return a=g,{start:d,len:x}}if(f>0){const{start:d,len:x,next:g}=this.#o(a,e,s,e,(e-n-o*e)/f);return a=g,{start:d,len:x}}const{start:r,len:h,next:u}=this.#o(a,e,s);return a=u,{start:r,len:h}})}#o(t,e,i,n,o){const a=this.#e(i.len,e,n??e),c=this.#e(i.ms,e,o??0),l=this.#e(i.me,e,o??0);return{len:a,start:t+c,next:t+a+c+l}}#u(t,e,i){if(i.len==="auto"){const f=this.#e(i.ms,e,0),s=this.#e(i.me,e,0),r=t+f,h=e-f-s;return{start:r,len:h}}const n=this.#e(i.len,e,e),o=(i.ms==="auto"?1:0)+(i.me==="auto"?1:0),a=this.#e(i.me,e,0),c=this.#e(i.ms,e,(e-n-a)/o);return{start:t+c,len:n}}#y(t,e){const i=e?t:this.#n;if(i&&!P(i.elem)){i.elem.type==="img"&&this.#w(i.elem.children[0],i.elem.props.id),i.elem.props.backgroundImage&&this.#w(i.elem.props.backgroundImage);for(const n of i.inner||[])this.#y(n,!0)}}#w(t,e){const i=e??(typeof t=="string"?t:"image");typeof t!="string"&&this.#r.set(i,t),!this.#f.includes(i)&&(this.#f.push(i),typeof t=="string"&&v(t).then(n=>{this.#r.set(i,n),this.#h()}))}#h(t,e){if(!t&&(this.#f.length!==this.#r.size||!this.#n?.inner?.[0]))return;const i=e?t:this.#n;if(!i||P(i.elem))return;!e&&this.#g&&console.log("Canvas Render",this.#n);const n=i.elem.props?.overflow==="hidden"?{pos:i.pos,radius:i.elem.props.borderRadius}:void 0;n&&this.#z(n.pos,n.radius);const o=i.elem.props?.clipPathLine?{pos:i.pos,path:i.elem.props.clipPathLine}:void 0;o&&this.#F(o.pos,o.path),i.elem.props&&this.#v(i.pos,i.elem.props),i.elem.type==="img"&&this.#C(i.pos,i.elem.children[0],i.elem.props),i.elem.type==="div"&&(typeof i.elem.children[0]=="string"||typeof i.elem.children[0]=="number")&&this.#I(i.pos,i.elem.children[0],i.elem.props);for(const a of i.inner||[])this.#h(a,!0);o&&this.#t.restore(),n&&this.#t.restore()}#I(t,e,i){const n=i?.textAlign||"left",o=n==="left"?t.x:n==="right"?t.x+t.w:t.x+t.w/2;if(this.#t.fillStyle=i?.color||this.#d,this.#S(i?.fontSize),this.#t.textAlign=n,this.#t.textBaseline="middle",i?.opacity&&(this.#t.globalAlpha=i.opacity),i?.shadow){this.#t.shadowBlur=i.shadow.size,this.#t.shadowColor=i.shadow.color||"#000";for(let a=0;a<(i.shadow?.for||1);a++)this.#t.fillText(e.toString(),o,t.y+t.h/2);this.#t.shadowBlur=0}else this.#t.fillText(e.toString(),o,t.y+t.h/2);i?.opacity&&(this.#t.globalAlpha=1)}#C(t,e,i){const n=i.id??(typeof e=="string"?e:"image");let o=this.#r.get(n);if(o){if(i.unsharpMask){const a=new OffscreenCanvas(t.w,t.h),c=a.getContext("2d"),[,,l,f,s,r,h,u]=p(o,t,i);c?.drawImage(o,0,0,l,f,s-t.x,r-t.y,h,u),F(a,...i.unsharpMask),o=a}if(i.opacity&&(this.#t.globalAlpha=i.opacity),i.shadow){this.#t.shadowBlur=i.shadow.size,this.#t.shadowColor=i.shadow.color||"#000";for(let a=0;a<(i.shadow?.for||1);a++)this.#t.drawImage(o,...p(o,t,i));this.#t.shadowBlur=0}else this.#t.drawImage(o,...p(o,t,i));i.opacity&&(this.#t.globalAlpha=1)}}#v(t,e){e.backgroundColor&&(this.#t.fillStyle=e.backgroundColor,this.#t.fillRect(t.x,t.y,t.w,t.h)),e.backgroundBlendMode&&(this.#t.globalCompositeOperation=e.backgroundBlendMode),e.backgroundImage&&this.#C(t,e.backgroundImage,{objectFit:e.objectFit}),e.backgroundBlendMode&&(this.#t.globalCompositeOperation="source-over"),e.border&&this.#k(t,e.borderRadius,e.border)}#k(t,e,i){const n=Array.isArray(i)?i:[i],o=this.#e(e,t.w<t.h?t.w:t.h,0);for(const a of n){const c=a.offset||0,l=a.width/2,f={x:t.x+c+l,y:t.y+c+l,w:t.w-c*2-l*2,h:t.h-c*2-l*2,z:t.z},s=o-c-l,r=0<s?s:0;this.#t.lineWidth=a.width,this.#t.strokeStyle=a.color,this.#P(f,r),this.#t.stroke()}}#P(t,e){this.#t.beginPath(),this.#t.moveTo(t.x+e,t.y),this.#t.lineTo(t.x+t.w-e,t.y),this.#t.arcTo(t.x+t.w,t.y,t.x+t.w,t.y+t.h,e),this.#t.lineTo(t.x+t.w,t.y+t.h-e),this.#t.arcTo(t.x+t.w,t.y+t.h,t.x,t.y+t.h,e),this.#t.lineTo(t.x+e,t.y+t.h),this.#t.arcTo(t.x,t.y+t.h,t.x,t.y,e),this.#t.lineTo(t.x,t.y+e),this.#t.arcTo(t.x,t.y,t.x+t.w,t.y,e),this.#t.closePath()}#z(t,e){const i=this.#e(e,t.w<t.h?t.w:t.h,0);this.#t.save(),this.#P(t,i),this.#t.clip()}#F(t,e){const i=e.map((n,o)=>o%2===0?t.x+this.#e(n,t.w,0):t.y+this.#e(n,t.h,0));this.#t.save(),this.#t.beginPath(),this.#t.moveTo(i[0],i[1]);for(let n=2;n<i.length;n+=2)this.#t.lineTo(i[n],i[n+1]);this.#t.lineTo(i[0],i[1]),this.#t.closePath(),this.#t.clip()}#e(t,e,i){if(t!==void 0){if(typeof t=="number")return t;if(t.endsWith("rem")){const n=Number(t.slice(0,-3));if(!Number.isNaN(n))return n*this.#i}if(e&&t.endsWith("%")){const n=Number(t.slice(0,-1));if(!Number.isNaN(n))return n*e/100}}return i??"auto"}#M(t,e){if(!(typeof t!="string"&&typeof t!="number"))return this.#S(e),this.#t.measureText(t.toString()).width}#S(t){this.#t.font=`${this.#e(t,this.#i,this.#i)}px ${this.#a?this.#l:S}`}}let C;self.onmessage=m=>{const{canvas:t,options:e,root:i}=m.data;if(!C&&t){const n=t.getContext("2d");n?C??=new B(t,n):new Error('web worker: OffscreenCanvas.getContext("2d")')}C&&(e&&C.options(e),C.render(i))};
