const S="Helvetica Neue, Arial, Hiragino Kaku Gothic ProN, Hiragino Sans, Meiryo, sans-serif",P=m=>typeof m!="object"||m instanceof ImageBitmap,v=m=>fetch(self.location.origin+m).then(t=>t.blob()).then(t=>createImageBitmap(t)),M=m=>{let[t,i,e]=m;return typeof i=="string"&&!i.startsWith("url(")&&(i=`url(${self.location.origin+i})`),e||(e={display:"swap"}),[t,i,e]},p=(m,t,i,e)=>{const n=m.width-(e?e[1]+e[3]:0),o=m.height-(e?e[0]+e[2]:0),a=t.w/t.h,f=n/o;let h;"objectFit"in i&&i.objectFit==="cover"?(a<f&&(h="y"),f<a&&(h="x")):(a<f&&(h="x"),f<a&&(h="y"));const c=e?.[3]??0,s=e?.[0]??0;if(h==="x"){const u={w:t.w,h:o*t.w/n},d=t.y+t.h/2-u.h/2;return[c,s,n,o,t.x,d,u.w,u.h]}const r={w:n*t.h/o,h:t.h},l=t.x+t.w/2-r.w/2;return[c,s,n,o,l,t.y,r.w,r.h]},k=m=>typeof m=="string"&&m.at(-1)==="%"?Number(m.slice(0,-1))/100:void 0,F=(m,t,i,e)=>{const n=m.getContext("2d");if(!n)return;const o=m.width,a=m.height,f=n.getImageData(0,0,o,a),h=new ImageData(new Uint8ClampedArray(f.data),o,a),c=new ImageData(new Uint8ClampedArray(f.data),o,a);z(c,i);const s=h.data,r=c.data;for(let l=0;l<s.length;l+=4)for(let u=0;u<3;u++){const d=s[l+u]-r[l+u];Math.abs(d)>e&&(s[l+u]=Math.min(Math.max(s[l+u]+d*t,0),255))}n.putImageData(h,0,0)},z=(m,t)=>{const i=m.width,e=m.height,n=m.data,o=new Uint8ClampedArray(n),a=t/3,f=2*a*a,h=Math.PI*f,c=[];let s=0;for(let r=-t;r<=t;r++){const l=Math.exp(-(r*r)/f)/h;c.push(l),s+=l}for(let r=0;r<c.length;r++)c[r]/=s;for(let r=0;r<e;r++)for(let l=0;l<i;l++){let u=0,d=0,x=0;for(let b=-t;b<=t;b++){const I=Math.min(Math.max(l+b,0),i-1),y=(r*i+I)*4,w=c[b+t];u+=o[y]*w,d+=o[y+1]*w,x+=o[y+2]*w}const g=(r*i+l)*4;n[g]=u,n[g+1]=d,n[g+2]=x}o.set(n);for(let r=0;r<i;r++)for(let l=0;l<e;l++){let u=0,d=0,x=0;for(let b=-t;b<=t;b++){const y=(Math.min(Math.max(l+b,0),e-1)*i+r)*4,w=c[b+t];u+=o[y]*w,d+=o[y+1]*w,x+=o[y+2]*w}const g=(l*i+r)*4;n[g]=u,n[g+1]=d,n[g+2]=x}},B=(m,t,i)=>{const e=m.getContext("2d",{willReadFrequently:!0});if(!e)return;const n=e.getImageData(0,0,m.width,m.height),o=n.data;for(let a=1;a<i.length;a++){const f=i[a-1][0],h=i[a][0],c=i[a-1][1],s=i[a][1];if(c===1&&s===1)continue;const r=t==="to right",l=r?m.height:m.width;for(let u=f;u<h;u++){const d=(u-f)/(h-f),x=c+(s-c)*d;for(let g=0;g<l;g++){const b=r?u:g,y=((r?g:u)*m.width+b)*4;o[y+3]=Math.round(o[y+3]*x)}}}e.putImageData(n,0,0)};class T{#s;#t;#c;#l=S;#i=16;#d="#000";#g;#n=void 0;#r=new Map;#f=[];#a=!1;constructor(t,i){this.#s=t,this.#t=i}options=t=>{t?.canvasWidth&&(this.#s.width=t.canvasWidth),t?.canvasHeight&&(this.#s.height=t.canvasHeight),t?.fontFace&&(this.#c=new FontFace(...M(t.fontFace)),this.#l=`${t.fontFace[0]}, ${S}`,this.#a=!1,self.fonts.add(this.#c)),t?.fontSize&&(this.#i=t.fontSize),t?.fontColor&&(this.#d=t.fontColor),t?.debugMode&&(this.#g=t.debugMode)};render(t){const i={x:0,y:0,z:0,w:this.#s.width,h:this.#s.height};this.#n={pos:i,elem:t,inner:this.#m(i,t)},this.#a?this.#h():this.#c?.load().then(()=>{self.fonts.check(`${this.#i}px ${this.#l}`)&&(this.#a=!0,this.#n={pos:i,elem:t,inner:this.#m(i,t)},this.#h())}),this.#y()}#m(t,i){if(P(i))return;const e=this.#S(t,i),n=i.children?.map((o,a)=>({pos:e[a],elem:o,inner:void 0}));for(const o of n)o.inner=this.#m(o.pos,o.elem);return n}#S(t,i){const e=this.#e(i.props.p,t.w,0),n=this.#e(i.props.p,t.h,0),o=this.#e(i.props.pt,t.h,n),a=this.#e(i.props.pr,t.w,e),f=this.#e(i.props.pb,t.h,n),h=this.#e(i.props.pl,t.w,e),c=i.children.map(s=>{if(P(s))return{z:0,w:"auto",h:"auto",mt:"auto",mr:"auto",mb:"auto",ml:"auto",position:void 0};const r=this.#e(s.props?.m,this.#i);return{z:s.props?.z??0,w:s.props?.w??(s.type!=="img"?this.#z(s.children[0],s.props.fontSize)??"auto":"auto"),h:s.props?.h??(s.type!=="img"&&(typeof s.children[0]=="string"||typeof s.children[0]=="number")?this.#e(s.props.fontSize,this.#i,this.#i)*1.5:"auto"),mt:s.props?.mt??r,mr:s.props?.mr??r,mb:s.props?.mb??r,ml:s.props?.ml??r,position:s.props?.position}});return i.props?.display==="flex"?this.#x({...t,pt:o,pr:a,pb:f,pl:h},c,"row"):this.#x({...t,pt:o,pr:a,pb:f,pl:h},c)}#x(t,i,e){const n=e==="row",o=t.x+t.pl,a=t.y+t.pt,f=t.w-t.pl-t.pr,h=t.h-t.pt-t.pb,c=this.#b(o,f,i.map(r=>({len:r.w,ms:r.ml,me:r.mr,pos:n?r.position:"absolute"}))),s=this.#b(a,h,i.map(r=>({len:r.h,ms:r.mt,me:r.mb,pos:n?"absolute":r.position})));return i.map((r,l)=>({x:c[l].start,y:s[l].start,z:r.z,w:c[l].len,h:s[l].len}))}#b(t,i,e){let n=0,o=0;for(const s of e)if(s.pos!=="absolute")for(const r of[s.len,s.ms,s.me])n+=this.#e(r,void 0,0),o+=k(r)||0;let a=t;if(i<n||i===n&&0<o)return e.map(s=>{if(s.pos==="absolute")return this.#u(t,i,s);const{start:r,len:l,next:u}=this.#o(a,i,s);return a=u,{start:r,len:l}});const f=(i-n)/i;if(f<o)return e.map(s=>{if(s.pos==="absolute")return this.#u(t,i,s);const{start:r,len:l,next:u}=this.#o(a,i*f/o,s);return a=u,{start:r,len:l}});let h=0,c=0;for(const s of e)s.pos!=="absolute"&&(s.len==="auto"&&h++,s.ms==="auto"&&c++,s.me==="auto"&&c++);return e.map(s=>{if(s.pos==="absolute")return this.#u(t,i,s);if(h>0){const{start:d,len:x,next:g}=this.#o(a,i,s,(i-n-o*i)/h);return a=g,{start:d,len:x}}if(c>0){const{start:d,len:x,next:g}=this.#o(a,i,s,i,(i-n-o*i)/c);return a=g,{start:d,len:x}}const{start:r,len:l,next:u}=this.#o(a,i,s);return a=u,{start:r,len:l}})}#o(t,i,e,n,o){const a=this.#e(e.len,i,n??i),f=this.#e(e.ms,i,o??0),h=this.#e(e.me,i,o??0);return{len:a,start:t+f,next:t+a+f+h}}#u(t,i,e){if(e.len==="auto"){const c=this.#e(e.ms,i,0),s=this.#e(e.me,i,0),r=t+c,l=i-c-s;return{start:r,len:l}}const n=this.#e(e.len,i,i),o=(e.ms==="auto"?1:0)+(e.me==="auto"?1:0),a=this.#e(e.me,i,0),f=this.#e(e.ms,i,(i-n-a)/o);return{start:t+f,len:n}}#y(t,i){const e=i?t:this.#n;if(e&&!P(e.elem)){e.elem.type==="img"&&this.#w(e.elem.children[0],e.elem.props.id),e.elem.props.backgroundImage&&this.#w(e.elem.props.backgroundImage);for(const n of e.inner||[])this.#y(n,!0)}}#w(t,i){const e=i??(typeof t=="string"?t:"image");typeof t!="string"&&this.#r.set(e,t),!this.#f.includes(e)&&(this.#f.push(e),typeof t=="string"&&v(t).then(n=>{this.#r.set(e,n),this.#h()}))}#h(t,i){if(!t&&(this.#f.length!==this.#r.size||!this.#n?.inner?.[0]))return;const e=i?t:this.#n;if(!e||P(e.elem))return;!i&&this.#g&&console.log("Canvas Render",this.#n);const n=e.elem.props?.overflow==="hidden"?{pos:e.pos,radius:e.elem.props.borderRadius}:void 0;n&&this.#k(n.pos,n.radius);const o=e.elem.props?.clipPathLine?{pos:e.pos,path:e.elem.props.clipPathLine}:void 0;o&&this.#F(o.pos,o.path),e.elem.props&&this.#v(e.pos,e.elem.props),e.elem.type==="img"&&this.#C(e.pos,e.elem.children[0],e.elem.props),e.elem.type==="div"&&(typeof e.elem.children[0]=="string"||typeof e.elem.children[0]=="number")&&this.#p(e.pos,e.elem.children[0],e.elem.props);for(const a of e.inner||[])this.#h(a,!0);o&&this.#t.restore(),n&&this.#t.restore()}#p(t,i,e){const n=e?.textAlign||"left",o=n==="left"?t.x:n==="right"?t.x+t.w:t.x+t.w/2;if(this.#t.fillStyle=e?.color||this.#d,this.#I(e?.fontSize),this.#t.textAlign=n,this.#t.textBaseline="middle",e?.opacity&&(this.#t.globalAlpha=e.opacity),e?.shadow){this.#t.shadowBlur=e.shadow.size,this.#t.shadowColor=e.shadow.color||"#000";for(let a=0;a<(e.shadow?.for||1);a++)this.#t.fillText(i.toString(),o,t.y+t.h/2);this.#t.shadowBlur=0}else this.#t.fillText(i.toString(),o,t.y+t.h/2);e?.opacity&&(this.#t.globalAlpha=1)}#C(t,i,e){const n=e.id??(typeof i=="string"?i:"image");let o=this.#r.get(n);if(o){if(e.clipImgRect||e.opacityGradient||e.unsharpMask){const a=new OffscreenCanvas(t.w,t.h);if(a.getContext("2d")?.drawImage(o,...p(o,{...t,x:0,y:0},e,e?.clipImgRect?.map((h,c)=>this.#e(h,c%2===0?o?.height:o?.width,0)))),e.opacityGradient){const h=e.opacityGradient[0],c=e.opacityGradient.slice(1);let s=[];h==="to right"?s=c.map(r=>[Math.round(this.#e(r[0],a.width,0)),r[1]]):h==="to bottom"&&(s=c.map(r=>[Math.round(this.#e(r[0],a.height,0)),r[1]])),B(a,h,s)}e.unsharpMask&&F(a,...e.unsharpMask),o=a}if(e.opacity&&(this.#t.globalAlpha=e.opacity),e.shadow){this.#t.shadowBlur=e.shadow.size,this.#t.shadowColor=e.shadow.color||"#000";for(let a=0;a<(e.shadow?.for||1);a++)this.#t.drawImage(o,...p(o,t,e));this.#t.shadowBlur=0}else this.#t.drawImage(o,...p(o,t,e));e.opacity&&(this.#t.globalAlpha=1)}}#v(t,i){i.backgroundColor&&(this.#t.fillStyle=i.backgroundColor,this.#t.fillRect(t.x,t.y,t.w,t.h)),i.backgroundBlendMode&&(this.#t.globalCompositeOperation=i.backgroundBlendMode),i.backgroundImage&&this.#C(t,i.backgroundImage,{objectFit:i.objectFit}),i.backgroundBlendMode&&(this.#t.globalCompositeOperation="source-over"),i.border&&this.#M(t,i.borderRadius,i.border)}#M(t,i,e){const n=Array.isArray(e)?e:[e],o=this.#e(i,t.w<t.h?t.w:t.h,0);for(const a of n){const f=a.offset||0,h=a.width/2,c={x:t.x+f+h,y:t.y+f+h,w:t.w-f*2-h*2,h:t.h-f*2-h*2,z:t.z},s=o-f-h,r=0<s?s:0;this.#t.lineWidth=a.width,this.#t.strokeStyle=a.color,this.#P(c,r),this.#t.stroke()}}#P(t,i){this.#t.beginPath(),this.#t.moveTo(t.x+i,t.y),this.#t.lineTo(t.x+t.w-i,t.y),this.#t.arcTo(t.x+t.w,t.y,t.x+t.w,t.y+t.h,i),this.#t.lineTo(t.x+t.w,t.y+t.h-i),this.#t.arcTo(t.x+t.w,t.y+t.h,t.x,t.y+t.h,i),this.#t.lineTo(t.x+i,t.y+t.h),this.#t.arcTo(t.x,t.y+t.h,t.x,t.y,i),this.#t.lineTo(t.x,t.y+i),this.#t.arcTo(t.x,t.y,t.x+t.w,t.y,i),this.#t.closePath()}#k(t,i){const e=this.#e(i,t.w<t.h?t.w:t.h,0);this.#t.save(),this.#P(t,e),this.#t.clip()}#F(t,i){const e=i.map((n,o)=>o%2===0?t.x+this.#e(n,t.w,0):t.y+this.#e(n,t.h,0));this.#t.save(),this.#t.beginPath(),this.#t.moveTo(e[0],e[1]);for(let n=2;n<e.length;n+=2)this.#t.lineTo(e[n],e[n+1]);this.#t.lineTo(e[0],e[1]),this.#t.closePath(),this.#t.clip()}#e(t,i,e){if(t!==void 0){if(typeof t=="number")return t;if(t.endsWith("rem")){const n=Number(t.slice(0,-3));if(!Number.isNaN(n))return n*this.#i}if(i&&t.endsWith("%")){const n=Number(t.slice(0,-1));if(!Number.isNaN(n))return n*i/100}}return e??"auto"}#z(t,i){if(!(typeof t!="string"&&typeof t!="number"))return this.#I(i),this.#t.measureText(t.toString()).width}#I(t){this.#t.font=`${this.#e(t,this.#i,this.#i)}px ${this.#a?this.#l:S}`}}let C;self.onmessage=m=>{const{canvas:t,options:i,root:e}=m.data;if(!C&&t){const n=t.getContext("2d");n?C??=new T(t,n):new Error('web worker: OffscreenCanvas.getContext("2d")')}C&&(i&&C.options(i),C.render(e))};
