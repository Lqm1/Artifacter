const y="Helvetica Neue, Arial, Hiragino Kaku Gothic ProN, Hiragino Sans, Meiryo, sans-serif",p=l=>{let[t,i,e]=l;return typeof i=="string"&&!i.startsWith("url(")&&(i=`url(${self.location.origin+i})`),[t,i,e]},C=l=>fetch(self.location.origin+l).then(t=>t.blob()).then(t=>createImageBitmap(t)),w=(l,t,i)=>{const e=l.width,n=l.height,o=t.w/t.h,r=e/n;let h;if("objectFit"in i&&i.objectFit==="cover"?(o<r&&(h="y"),r<o&&(h="x")):(o<r&&(h="x"),r<o&&(h="y")),h==="x"){const s={w:t.w,h:n*t.w/e},a=t.y+t.h/2-s.h/2;return[0,0,e,n,t.x,a,s.w,s.h]}const c={w:e*t.h/n,h:t.h},f=t.x+t.w/2-c.w/2;return[0,0,e,n,f,t.y,c.w,c.h]},P=l=>typeof l=="string"&&l.at(-1)==="%"?Number(l.slice(0,-1))/100:void 0;class v{#o;#t;#f;#l=y;#i=16;#g="#000";#b;#n=void 0;#r=new Map;#s=[];#c=!1;constructor(t,i){this.#o=t,this.#t=i}options=t=>{t?.canvasWidth&&(this.#o.width=t.canvasWidth),t?.canvasHeight&&(this.#o.height=t.canvasHeight),t?.fontFace&&(this.#f=new FontFace(...p(t.fontFace)),this.#l=`${t.fontFace[0]}, ${y}`,this.#c=!1,self.fonts.add(this.#f)),t?.fontSize&&(this.#i=t.fontSize),t?.fontColor&&(this.#g=t.fontColor),t?.debugMode&&(this.#b=t.debugMode)};render(t){const i={x:0,y:0,z:0,w:this.#o.width,h:this.#o.height};this.#n={pos:i,elem:t,inner:this.#u(i,t)},this.#c?this.#h():this.#f?.load().then(()=>{self.fonts.check(`${this.#i}px ${this.#l}`)&&(this.#c=!0,this.#n={pos:i,elem:t,inner:this.#u(i,t)},this.#h())}),this.#w()}#u(t,i){const e=this.#v(t,i);if(typeof i!="object"||!e)return;const n=i.children?.map((o,r)=>({pos:e[r],elem:o,inner:void 0}));for(const o of n)o.inner=this.#u(o.pos,o.elem);return n}#v(t,i){if(typeof i!="object")return;const e=this.#e(i.props.p,t.w,0),n=this.#e(i.props.p,t.h,0),o=this.#e(i.props.pt,t.h,n),r=this.#e(i.props.pr,t.w,e),h=this.#e(i.props.pb,t.h,n),c=this.#e(i.props.pl,t.w,e),f=i.children.map(s=>{if(typeof s!="object")return{z:0,w:"auto",h:"auto",mt:"auto",mr:"auto",mb:"auto",ml:"auto",position:void 0};const a=this.#e(s.props?.m,this.#i);return{z:s.props?.z??0,w:s.props?.w??this.#B(s.children[0],s.props.fontSize)??"auto",h:s.props?.h??(typeof s.children[0]=="string"||typeof s.children[0]=="number"?this.#e(s.props.fontSize,this.#i,this.#i)*1.5:"auto"),mt:s.props?.mt??a,mr:s.props?.mr??a,mb:s.props?.mb??a,ml:s.props?.ml??a,position:s.props?.position}});return i.props?.display==="flex"?this.#x({...t,pt:o,pr:r,pb:h,pl:c},f,"row"):this.#x({...t,pt:o,pr:r,pb:h,pl:c},f)}#x(t,i,e){const n=e==="row",o=t.x+t.pl,r=t.y+t.pt,h=t.w-t.pl-t.pr,c=t.h-t.pt-t.pb,f=this.#y(o,h,i.map(a=>({len:a.w,ms:a.ml,me:a.mr,pos:n?a.position:"absolute"}))),s=this.#y(r,c,i.map(a=>({len:a.h,ms:a.mt,me:a.mb,pos:n?"absolute":a.position})));return i.map((a,u)=>({x:f[u].start,y:s[u].start,z:a.z,w:f[u].len,h:s[u].len}))}#y(t,i,e){let n=0,o=0;for(const s of e)if(s.pos!=="absolute")for(const a of[s.len,s.ms,s.me])n+=this.#e(a,void 0,0),o+=P(a)||0;let r=t;if(i<n||i===n&&0<o)return e.map(s=>{if(s.pos==="absolute")return this.#m(t,i,s);const{start:a,len:u,next:m}=this.#a(r,i,s);return r=m,{start:a,len:u}});const h=(i-n)/i;if(h<o)return e.map(s=>{if(s.pos==="absolute")return this.#m(t,i,s);const{start:a,len:u,next:m}=this.#a(r,i*h/o,s);return r=m,{start:a,len:u}});let c=0,f=0;for(const s of e)s.pos!=="absolute"&&(s.len==="auto"&&c++,s.ms==="auto"&&f++,s.me==="auto"&&f++);return e.map(s=>{if(s.pos==="absolute")return this.#m(t,i,s);if(c>0){const{start:g,len:b,next:x}=this.#a(r,i,s,(i-n-o*i)/c);return r=x,{start:g,len:b}}if(f>0){const{start:g,len:b,next:x}=this.#a(r,i,s,i,(i-n-o*i)/f);return r=x,{start:g,len:b}}const{start:a,len:u,next:m}=this.#a(r,i,s);return r=m,{start:a,len:u}})}#a(t,i,e,n,o){const r=this.#e(e.len,i,n??i),h=this.#e(e.ms,i,o??0),c=this.#e(e.me,i,o??0);return{len:r,start:t+h,next:t+r+h+c}}#m(t,i,e){if(e.len==="auto"){const f=this.#e(e.ms,i,0),s=this.#e(e.me,i,0),a=t+f,u=i-f-s;return{start:a,len:u}}const n=this.#e(e.len,i,i),o=(e.ms==="auto"?1:0)+(e.me==="auto"?1:0),r=this.#e(e.me,i,0),h=this.#e(e.ms,i,(i-n-r)/o);return{start:t+h,len:n}}#w(t,i){const e=i?t:this.#n;if(e&&!(typeof e.elem!="object"||!e.elem)){e.elem.type==="img"&&this.#p(e.elem.props.src),e.elem.props.backgroundImage&&this.#p(e.elem.props.backgroundImage),e.elem.type==="canvas"&&this.#S(e.elem.props.id||"canvas",e.elem.props.func,e.pos,e.elem.props.refresh);for(const n of e.inner||[])this.#w(n,!0)}}#p(t){this.#s.includes(t)||(this.#s.push(t),C(t).then(i=>{this.#r.set(t,i),this.#h()}))}#S(t,i,e,n=!0){if(!n&&this.#s.includes(t))return;this.#s.includes(t)||this.#s.push(t);let o=this.#r.get(t);o instanceof OffscreenCanvas?(o.width=Math.round(e.w),o.height=Math.round(e.h)):o=new OffscreenCanvas(Math.round(e.w),Math.round(e.h)),i(o).then(()=>{this.#r.set(t,o),this.#h()})}#h(t,i){if(!t&&(this.#s.length!==this.#r.size||!this.#n?.inner?.[0]))return;const e=i?t:this.#n;if(!e||typeof e.elem!="object"||!e.elem)return;!i&&this.#b&&console.log("Canvas Render",this.#n);const n=e.elem.props?.overflow==="hidden"?{pos:e.pos,radius:e.elem.props.borderRadius}:void 0;n&&this.#k(n.pos,n.radius);const o=e.elem.props?.clipPathLine?{pos:e.pos,path:e.elem.props.clipPathLine}:void 0;o&&this.#T(o.pos,o.path),e.elem.props&&this.#z(e.pos,e.elem.props),e.elem.type==="img"&&this.#d(e.pos,e.elem.props?.src||"",e.elem.props),e.elem.type==="canvas"&&this.#d(e.pos,e.elem.props?.id||"canvas",e.elem.props),e.elem.type==="div"&&(typeof e.elem.children[0]=="string"||typeof e.elem.children[0]=="number")&&this.#I(e.pos,e.elem.children[0],e.elem.props);for(const r of e.inner||[])this.#h(r,!0);o&&this.#t.restore(),n&&this.#t.restore()}#I(t,i,e){const n=e?.textAlign||"left",o=n==="left"?t.x:n==="right"?t.x+t.w:t.x+t.w/2;if(this.#t.fillStyle=e?.color||this.#g,this.#P(e?.fontSize),this.#t.textAlign=n,this.#t.textBaseline="middle",e?.opacity&&(this.#t.globalAlpha=e.opacity),e?.shadow){this.#t.shadowBlur=e.shadow.size,this.#t.shadowColor=e.shadow.color||"#000";for(let r=0;r<(e.shadow?.for||1);r++)this.#t.fillText(i.toString(),o,t.y+t.h/2);this.#t.shadowBlur=0}else this.#t.fillText(i.toString(),o,t.y+t.h/2);e?.opacity&&(this.#t.globalAlpha=1)}#d(t,i,e){const n=this.#r.get(i);if(n){if(e.opacity&&(this.#t.globalAlpha=e.opacity),e.shadow){this.#t.shadowBlur=e.shadow.size,this.#t.shadowColor=e.shadow.color||"#000";for(let o=0;o<(e.shadow?.for||1);o++)this.#t.drawImage(n,...w(n,t,e));this.#t.shadowBlur=0}else this.#t.drawImage(n,...w(n,t,e));e.opacity&&(this.#t.globalAlpha=1)}}#z(t,i){i.backgroundColor&&(this.#t.fillStyle=i.backgroundColor,this.#t.fillRect(t.x,t.y,t.w,t.h)),i.backgroundBlendMode&&(this.#t.globalCompositeOperation=i.backgroundBlendMode),i.backgroundImage&&this.#d(t,i.backgroundImage,{objectFit:i.objectFit}),i.backgroundBlendMode&&(this.#t.globalCompositeOperation="source-over"),i.border&&this.#F(t,i.borderRadius,i.border)}#F(t,i,e){const n=Array.isArray(e)?e:[e],o=this.#e(i,t.w<t.h?t.w:t.h,0);for(const r of n){const h=r.offset||0,c=r.width/2,f={x:t.x+h+c,y:t.y+h+c,w:t.w-h*2-c*2,h:t.h-h*2-c*2,z:t.z},s=o-h-c,a=0<s?s:0;this.#t.lineWidth=r.width,this.#t.strokeStyle=r.color,this.#C(f,a),this.#t.stroke()}}#C(t,i){this.#t.beginPath(),this.#t.moveTo(t.x+i,t.y),this.#t.lineTo(t.x+t.w-i,t.y),this.#t.arcTo(t.x+t.w,t.y,t.x+t.w,t.y+t.h,i),this.#t.lineTo(t.x+t.w,t.y+t.h-i),this.#t.arcTo(t.x+t.w,t.y+t.h,t.x,t.y+t.h,i),this.#t.lineTo(t.x+i,t.y+t.h),this.#t.arcTo(t.x,t.y+t.h,t.x,t.y,i),this.#t.lineTo(t.x,t.y+i),this.#t.arcTo(t.x,t.y,t.x+t.w,t.y,i),this.#t.closePath()}#k(t,i){const e=this.#e(i,t.w<t.h?t.w:t.h,0);this.#t.save(),this.#C(t,e),this.#t.clip()}#T(t,i){const e=i.map((n,o)=>o%2===0?t.x+this.#e(n,t.w,0):t.y+this.#e(n,t.h,0));this.#t.save(),this.#t.beginPath(),this.#t.moveTo(e[0],e[1]);for(let n=2;n<e.length;n+=2)this.#t.lineTo(e[n],e[n+1]);this.#t.lineTo(e[0],e[1]),this.#t.closePath(),this.#t.clip()}#e(t,i,e){if(t!==void 0){if(typeof t=="number")return t;if(t.endsWith("rem")){const n=Number(t.slice(0,-3));if(!Number.isNaN(n))return n*this.#i}if(i&&t.endsWith("%")){const n=Number(t.slice(0,-1));if(!Number.isNaN(n))return n*i/100}}return e??"auto"}#B(t,i){if(!(typeof t!="string"&&typeof t!="number"))return this.#P(i),this.#t.measureText(t.toString()).width}#P(t){this.#t.font=`${this.#e(t,this.#i,this.#i)}px ${this.#c?this.#l:y}`}}let d;self.onmessage=l=>{const{canvas:t,options:i,root:e}=l.data;if(!d&&t){const n=t.getContext("2d");n?d??=new v(t,n):new Error('web worker: OffscreenCanvas.getContext("2d")')}d&&(i&&d.options(i),d.render(e))};
